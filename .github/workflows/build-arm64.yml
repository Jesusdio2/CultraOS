name: Build ISO arm64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04   # ðŸ‘ˆ usar jammy en lugar de ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc libpng-dev zlib1g-dev cpio curl \
          grub-common grub-pc-bin grub2-common grub-efi-arm64-bin xorriso mtools

    - name: Download kernel and initramfs from release
      run: |
        mkdir kernel
        curl -L -o kernel/Image https://github.com/Jesusdio2/CultraOS/releases/download/Dev0/Image
        curl -L -o kernel/initramfs.img https://github.com/Jesusdio2/CultraOS/releases/download/Dev0/initramfs.img

    - name: Build UI and pack initramfs
      run: |
        gcc -O2 -Wall -Wextra src/main.c -o src/ui -lpng -lz
        mkdir -p initramfs/{bin,etc,proc,sys,dev/input}
        cp src/ui initramfs/bin/
        cp src/pointer.png initramfs/
        cat > initramfs/init << 'EOF'
        #!/bin/sh
        mount -t proc none /proc
        [ -d /dev ] || mkdir -p /dev
        [ -d /dev/input ] || mkdir -p /dev/input
        mknod -m 0666 /dev/fb0 c 29 0 2>/dev/null || true
        for i in 0 1 2 3 4 5 6 7; do
          mknod /dev/input/event$i c 13 $((64 + i)) 2>/dev/null || true
        done
        exec /bin/ui
        EOF
        chmod +x initramfs/init
        cd initramfs && find . | cpio -o -H newc | gzip > ../initramfs.img

    - name: Create ISO with UEFI bootloader
      run: |
        mkdir -p iso-root/boot/grub
        mkdir -p iso-root/EFI/BOOT
        cp kernel/Image iso-root/boot/
        cp initramfs.img iso-root/boot/
        cat > iso-root/boot/grub/grub.cfg << 'EOF'
        set timeout=0
        set default=0
        menuentry "CultraOS" {
            linux /boot/Image
            initrd /boot/initramfs.img
        }
        EOF
        grub-install \
          --target=arm64-efi \
          --efi-directory=iso-root/EFI \
          --boot-directory=iso-root/boot \
          --removable \
          --no-nvram
        cp iso-root/boot/grub/grub.efi iso-root/EFI/BOOT/BOOTAA64.EFI
        xorriso -as mkisofs \
          -R -J -joliet -l \
          -efi-boot-part --efi-boot-image --protective-msdos-label \
          -o CultraOS.iso \
          iso-root

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: CultraOS-iso
        path: CultraOS.iso
